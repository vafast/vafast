# åµŒå¥—è·¯ç”±å’Œä¸­é—´ä»¶ç»§æ‰¿

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† Vafast æ¡†æ¶çš„åµŒå¥—è·¯ç”±åŠŸèƒ½ï¼Œæ”¯æŒè·¯ç”±åˆ†ç»„å’Œä¸­é—´ä»¶ç»§æ‰¿ã€‚

## ç‰¹æ€§

- **è·¯ç”±åˆ†ç»„**: å°†ç›¸å…³è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·ï¼Œæé«˜ä»£ç å¯è¯»æ€§
- **ä¸­é—´ä»¶ç»§æ‰¿**: å­è·¯ç”±è‡ªåŠ¨ç»§æ‰¿çˆ¶è·¯ç”±çš„ä¸­é—´ä»¶
- **è·¯å¾„æ‹¼æ¥**: è‡ªåŠ¨æ‹¼æ¥çˆ¶è·¯ç”±å’Œå­è·¯ç”±çš„è·¯å¾„
- **ä¸­é—´ä»¶é“¾**: æ”¯æŒå¤æ‚çš„ä¸­é—´ä»¶ç»„åˆ

## ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºè¯¦è§£

### ğŸ¯ æ ¸å¿ƒåŸç†

ä¸­é—´ä»¶æ‰§è¡Œéµå¾ª **æ´‹è‘±æ¨¡å‹ï¼ˆOnion Modelï¼‰**ï¼Œå°±åƒå‰¥æ´‹è‘±ä¸€æ ·ï¼š
1. **è¿›å…¥é˜¶æ®µ**: ä»å¤–åˆ°å†…ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªä¸­é—´ä»¶çš„å‰ç½®é€»è¾‘
2. **å¤„ç†é˜¶æ®µ**: æ‰§è¡Œæœ€ç»ˆçš„å¤„ç†å™¨å‡½æ•°
3. **ç¦»å¼€é˜¶æ®µ**: ä»å†…åˆ°å¤–ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªä¸­é—´ä»¶çš„åç½®é€»è¾‘

### ğŸ“Š æ‰§è¡Œé¡ºåºç¤ºä¾‹

ä»¥è·¯ç”± `/demo/level1/level2/final` ä¸ºä¾‹ï¼š

```
ğŸ”„ [1] è¿›å…¥ä¸­é—´ä»¶: å…¨å±€ä¸­é—´ä»¶1
ğŸ”„ [2] è¿›å…¥ä¸­é—´ä»¶: å…¨å±€ä¸­é—´ä»¶2
ğŸ”„ [3] è¿›å…¥ä¸­é—´ä»¶: ä¸€çº§ä¸­é—´ä»¶1
ğŸ”„ [4] è¿›å…¥ä¸­é—´ä»¶: ä¸€çº§ä¸­é—´ä»¶2
ğŸ”„ [5] è¿›å…¥ä¸­é—´ä»¶: äºŒçº§ä¸­é—´ä»¶1
ğŸ”„ [6] è¿›å…¥ä¸­é—´ä»¶: äºŒçº§ä¸­é—´ä»¶2
ğŸ”„ [7] è¿›å…¥ä¸­é—´ä»¶: æœ€ç»ˆä¸­é—´ä»¶1
ğŸ”„ [8] è¿›å…¥ä¸­é—´ä»¶: æœ€ç»ˆä¸­é—´ä»¶2
ğŸ¯ æ‰§è¡Œå¤„ç†å™¨å‡½æ•°
âœ… [8] ç¦»å¼€ä¸­é—´ä»¶: æœ€ç»ˆä¸­é—´ä»¶2
âœ… [7] ç¦»å¼€ä¸­é—´ä»¶: æœ€ç»ˆä¸­é—´ä»¶1
âœ… [6] ç¦»å¼€ä¸­é—´ä»¶: äºŒçº§ä¸­é—´ä»¶2
âœ… [5] ç¦»å¼€ä¸­é—´ä»¶: äºŒçº§ä¸­é—´ä»¶1
âœ… [4] ç¦»å¼€ä¸­é—´ä»¶: ä¸€çº§ä¸­é—´ä»¶2
âœ… [3] ç¦»å¼€ä¸­é—´ä»¶: ä¸€çº§ä¸­é—´ä»¶1
âœ… [2] ç¦»å¼€ä¸­é—´ä»¶: å…¨å±€ä¸­é—´ä»¶2
âœ… [1] ç¦»å¼€ä¸­é—´ä»¶: å…¨å±€ä¸­é—´ä»¶1
```

### ğŸ”„ æ‰§è¡Œæµç¨‹

```
è¯·æ±‚ â†’ ä¸­é—´ä»¶1 â†’ ä¸­é—´ä»¶2 â†’ ... â†’ å¤„ç†å™¨ â†’ ... â†’ ä¸­é—´ä»¶2 â†’ ä¸­é—´ä»¶1 â†’ å“åº”
```

1. **è¯·æ±‚è¿›å…¥**: ä»ç¬¬ä¸€ä¸ªä¸­é—´ä»¶å¼€å§‹
2. **å±‚å±‚æ·±å…¥**: æ¯ä¸ªä¸­é—´ä»¶è°ƒç”¨ `next()` è¿›å…¥ä¸‹ä¸€å±‚
3. **åˆ°è¾¾æ ¸å¿ƒ**: æ‰§è¡Œå¤„ç†å™¨å‡½æ•°
4. **å±‚å±‚è¿”å›**: ä»æœ€å†…å±‚å¼€å§‹ï¼Œä¾æ¬¡è¿”å›åˆ°æœ€å¤–å±‚
5. **å“åº”è¿”å›**: æœ€ç»ˆå“åº”è¿”å›ç»™å®¢æˆ·ç«¯

### ğŸ—ï¸ ä¸­é—´ä»¶é“¾æ„å»ºè§„åˆ™

#### 1. æ‰å¹³åŒ–è¿‡ç¨‹
```typescript
// åµŒå¥—è·¯ç”±
{
  path: "/admin",
  middleware: [auth, rateLimit],
  children: [
    {
      path: "/dashboard",
      middleware: [audit],
      handler: dashboardHandler
    }
  ]
}

// æ‰å¹³åŒ–å
{
  path: "/admin/dashboard",
  middlewareChain: [auth, rateLimit, audit],
  handler: dashboardHandler
}
```

#### 2. æ‰§è¡Œé¡ºåº
```typescript
// ä¸­é—´ä»¶é“¾: [auth, rateLimit, audit]
// æ‰§è¡Œé¡ºåº:
auth â†’ rateLimit â†’ audit â†’ handler â†’ audit â†’ rateLimit â†’ auth
```

### ğŸ“ å®é™…åº”ç”¨ç¤ºä¾‹

#### ç®¡ç†å‘˜è·¯ç”±ç»„
```typescript
{
  path: "/admin",
  middleware: [
    requireAuth({ role: 'admin' }),     // 1. èº«ä»½éªŒè¯
    rateLimit({ max: 100, window: '1m' }) // 2. é™æµ
  ],
  children: [
    {
      path: "/dashboard",
      method: "GET",
      handler: dashboardHandler,
      middleware: [auditLog()]          // 3. å®¡è®¡æ—¥å¿—
    }
  ]
}
```

**æ‰§è¡Œé¡ºåº**:
```
è¿›å…¥: requireAuth â†’ rateLimit â†’ auditLog â†’ handler
ç¦»å¼€: handler â†’ auditLog â†’ rateLimit â†’ requireAuth
```

#### API ç‰ˆæœ¬ç®¡ç†
```typescript
{
  path: "/api",
  middleware: [cors, jsonParser],       // 1-2. åŸºç¡€ä¸­é—´ä»¶
  children: [
    {
      path: "/v1",
      middleware: [
        versionCheck('v1'),             // 3. ç‰ˆæœ¬æ£€æŸ¥
        rateLimit({ max: 1000 })        // 4. é™æµ
      ],
      children: [
        {
          path: "/users",
          method: "GET",
          handler: getUsersHandler,
          middleware: [cache({ ttl: '5m' })] // 5. ç¼“å­˜
        }
      ]
    }
  ]
}
```

**æ‰§è¡Œé¡ºåº**:
```
è¿›å…¥: cors â†’ jsonParser â†’ versionCheck â†’ rateLimit â†’ cache â†’ handler
ç¦»å¼€: handler â†’ cache â†’ rateLimit â†’ versionCheck â†’ jsonParser â†’ cors
```

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸­é—´ä»¶é¡ºåº**: çˆ¶è·¯ç”±ä¸­é—´ä»¶å…ˆæ‰§è¡Œï¼Œå­è·¯ç”±ä¸­é—´ä»¶åæ‰§è¡Œ
2. **é”™è¯¯å¤„ç†**: å¦‚æœä¸­é—´ä»¶æŠ›å‡ºé”™è¯¯ï¼Œåç»­ä¸­é—´ä»¶ä¸ä¼šæ‰§è¡Œ
3. **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰ä¸­é—´ä»¶éƒ½æ”¯æŒå¼‚æ­¥æ“ä½œ
4. **æ€§èƒ½**: ä¸­é—´ä»¶åœ¨å¯åŠ¨æ—¶æ‰å¹³åŒ–ï¼Œè¿è¡Œæ—¶æ€§èƒ½ä¸å—å½±å“

### ğŸ§ª æµ‹è¯•ä¸­é—´ä»¶é¡ºåº

è¿è¡Œç¤ºä¾‹æŸ¥çœ‹è¯¦ç»†çš„ä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ï¼š

```bash
npm run example/advanced/middleware-order.ts
```

## è·¯ç”±ç»“æ„

```typescript
const routes: NestedRoute[] = [
  {
    path: "/admin", // çˆ¶è·¯ç”±ï¼Œåªæ˜¯åˆ†ç»„
    middleware: [
      requireAuth({ role: 'admin' }),
      rateLimit({ max: 100, window: '1m' })
    ],
    children: [
      {
        path: "/dashboard", // å®é™…è·¯å¾„: /admin/dashboard
        method: "GET",
        handler: adminDashboardHandler,
        middleware: [auditLog()] // é¢å¤–æ·»åŠ çš„ä¸­é—´ä»¶
      },
      {
        path: "/users", // å®é™…è·¯å¾„: /admin/users
        method: "GET",
        handler: getUsersHandler,
        // ç»§æ‰¿çˆ¶è·¯ç”±çš„ä¸­é—´ä»¶ï¼šrequireAuth + rateLimit
      }
    ]
  }
];
```

## ä¸­é—´ä»¶ç»§æ‰¿è§„åˆ™

1. **çˆ¶è·¯ç”±ä¸­é—´ä»¶**: æ‰€æœ‰å­è·¯ç”±éƒ½ä¼šç»§æ‰¿
2. **å­è·¯ç”±ä¸­é—´ä»¶**: åœ¨çˆ¶è·¯ç”±ä¸­é—´ä»¶ä¹‹åæ‰§è¡Œ
3. **æ‰§è¡Œé¡ºåº**: çˆ¶ä¸­é—´ä»¶ â†’ å­ä¸­é—´ä»¶ â†’ å¤„ç†å™¨

### ç¤ºä¾‹ï¼š/admin/dashboard çš„ä¸­é—´ä»¶é“¾

```
requireAuth({ role: 'admin' }) â†’ rateLimit({ max: 100, window: '1m' }) â†’ auditLog() â†’ handler
```

### ç¤ºä¾‹ï¼š/api/v1/users çš„ä¸­é—´ä»¶é“¾

```
cors() â†’ jsonParser() â†’ errorHandler() â†’ versionCheck('v1') â†’ rateLimit({ max: 1000, window: '1m' }) â†’ cache({ ttl: '5m' }) â†’ handler
```

## è·¯å¾„æ‹¼æ¥è§„åˆ™

- çˆ¶è·¯ç”±è·¯å¾„ + å­è·¯ç”±è·¯å¾„ = å®Œæ•´è·¯å¾„
- è‡ªåŠ¨å¤„ç†æ–œæ ï¼Œé¿å…é‡å¤
- æ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—

```typescript
// è·¯å¾„: /api
{
  path: "/api",
  children: [
    // è·¯å¾„: /api/v1
    {
      path: "/v1",
      children: [
        // æœ€ç»ˆè·¯å¾„: /api/v1/users
        {
          path: "/users",
          // ...
        }
      ]
    }
  ]
}
```

## ä½¿ç”¨åœºæ™¯

### 1. ç®¡ç†å‘˜è·¯ç”±ç»„
```typescript
{
  path: "/admin",
  middleware: [requireAuth({ role: 'admin' }), rateLimit({ max: 100, window: '1m' })],
  children: [
    { path: "/dashboard", method: "GET", handler: dashboardHandler },
    { path: "/users", method: "GET", handler: usersHandler },
    { path: "/settings", method: "GET", handler: settingsHandler }
  ]
}
```

### 2. API ç‰ˆæœ¬ç®¡ç†
```typescript
{
  path: "/api",
  middleware: [cors(), jsonParser()],
  children: [
    {
      path: "/v1",
      middleware: [versionCheck('v1')],
      children: [
        { path: "/users", method: "GET", handler: getUsersV1 },
        { path: "/posts", method: "GET", handler: getPostsV1 }
      ]
    },
    {
      path: "/v2",
      middleware: [versionCheck('v2')],
      children: [
        { path: "/users", method: "GET", handler: getUsersV2 },
        { path: "/posts", method: "GET", handler: getPostsV2 }
      ]
    }
  ]
}
```

### 3. åŠŸèƒ½æ¨¡å—åˆ†ç»„
```typescript
{
  path: "/shop",
  middleware: [auth(), shopMiddleware()],
  children: [
    {
      path: "/products",
      children: [
        { path: "/", method: "GET", handler: listProducts },
        { path: "/:id", method: "GET", handler: getProduct }
      ]
    },
    {
      path: "/orders",
      children: [
        { path: "/", method: "POST", handler: createOrder },
        { path: "/:id", method: "GET", handler: getOrder }
      ]
    }
  ]
}
```

## è¿è¡Œç¤ºä¾‹

```bash
# è¿è¡ŒåµŒå¥—è·¯ç”±ç¤ºä¾‹
npm run example/advanced/nested-routes.ts

# è¿è¡Œä¸­é—´ä»¶é¡ºåºæ¼”ç¤º
npm run example/advanced/middleware-order.ts
```

## æ³¨æ„äº‹é¡¹

1. **ä¸­é—´ä»¶é¡ºåº**: çˆ¶è·¯ç”±ä¸­é—´ä»¶å…ˆæ‰§è¡Œï¼Œå­è·¯ç”±ä¸­é—´ä»¶åæ‰§è¡Œ
2. **è·¯å¾„å†²çª**: æ¡†æ¶ä¼šè‡ªåŠ¨æ£€æµ‹è·¯å¾„å†²çªå¹¶å‘å‡ºè­¦å‘Š
3. **æ€§èƒ½**: åµŒå¥—è·¯ç”±åœ¨å¯åŠ¨æ—¶ä¼šè¢«æ‰å¹³åŒ–ï¼Œè¿è¡Œæ—¶æ€§èƒ½ä¸å—å½±å“
4. **è°ƒè¯•**: å¯åŠ¨æ—¶ä¼šæ‰“å°æ‰å¹³åŒ–åçš„è·¯ç”±ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

## ç±»å‹å®šä¹‰

```typescript
interface NestedRoute {
  path: string;
  middleware?: Middleware[];
  children?: (NestedRoute | Route)[];
}

interface FlattenedRoute extends Route {
  fullPath: string;
  middlewareChain: Middleware[];
}
```

è¿™ä¸ªåŠŸèƒ½è®©è·¯ç”±ç»„ç»‡æ›´åŠ æ¸…æ™°ï¼Œä¸­é—´ä»¶ç®¡ç†æ›´åŠ çµæ´»ï¼Œç‰¹åˆ«é€‚åˆå¤§å‹åº”ç”¨çš„æ¶æ„è®¾è®¡ã€‚
